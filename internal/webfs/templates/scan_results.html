{{define "scan-config-content"}}
{{if .Run.Paths}}
<div class="scan-config-section">
    <strong>Paths:</strong>
    <ul class="config-list">
        {{range .Run.Paths}}<li><code>{{.}}</code></li>{{end}}
    </ul>
</div>
{{end}}
{{if or (gt .Run.MinSize 0) .Run.MaxSize .Run.IncludePatterns .Run.ExcludePatterns}}
<div class="scan-config-section">
    <strong>Filters:</strong>
    <ul class="config-list">
        {{if gt .Run.MinSize 0}}<li>Min size: {{.Run.MinSize | formatSizeInput}}</li>{{end}}
        {{if .Run.MaxSize}}<li>Max size: {{derefInt64 .Run.MaxSize | formatSizeInput}}</li>{{end}}
        {{if .Run.IncludePatterns}}<li>Include: {{joinPatterns .Run.IncludePatterns}}</li>{{end}}
        {{if .Run.ExcludePatterns}}<li>Exclude: {{joinPatterns .Run.ExcludePatterns}}</li>{{end}}
    </ul>
</div>
{{end}}
{{if or .Run.IncludeHidden .Run.FollowLinks .Run.OneFileSystem .Run.NoIgnore .Run.IgnoreCase .Run.MaxDepth}}
<div class="scan-config-section">
    <strong>Options:</strong>
    <ul class="config-list">
        {{if .Run.IncludeHidden}}<li>Include hidden files</li>{{end}}
        {{if .Run.FollowLinks}}<li>Follow symbolic links</li>{{end}}
        {{if .Run.OneFileSystem}}<li>Same filesystem only</li>{{end}}
        {{if .Run.NoIgnore}}<li>Ignore .gitignore</li>{{end}}
        {{if .Run.IgnoreCase}}<li>Case-insensitive patterns</li>{{end}}
        {{if .Run.MaxDepth}}<li>Max depth: {{derefInt .Run.MaxDepth}}</li>{{end}}
    </ul>
</div>
{{end}}
{{end}}

{{define "content"}}
<div class="page-header">
    <h1>Scan Results</h1>
    <div class="actions-bar">
        {{if eq .Run.Status "running"}}
        <form action="/scans/runs/{{.Run.ID}}/cancel" method="POST">
            {{csrfField .CSRFToken}}
            <button type="submit" class="btn btn-danger">Cancel Scan</button>
        </form>
        {{end}}
        <a href="/history" class="btn back-btn">Back to History</a>
    </div>
</div>

{{if eq .Run.Status "running"}}
<div class="card" id="scan-progress">
    <div class="card-header">
        <span>Scan in Progress</span>
        <span class="loading"></span>
    </div>
    <div class="card-body">
        <div class="phase-timeline" id="phase-timeline">
            <!-- Phases are created dynamically based on phase_total -->
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="files-scanned">{{if gt .Run.FilesScanned 0}}{{.Run.FilesScanned}}{{else}}-{{end}}</div>
                <div class="stat-label">Files Matched</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bytes-scanned">{{if gt .Run.BytesScanned 0}}{{.Run.BytesScanned | formatBytes}}{{else}}-{{end}}</div>
                <div class="stat-label">Data Matched</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="groups-found">{{if gt .Run.DuplicateGroups 0}}{{.Run.DuplicateGroups}}{{else}}-{{end}}</div>
                <div class="stat-label">Groups Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="wasted-bytes">{{if gt .Run.WastedBytes 0}}{{.Run.WastedBytes | formatBytes}}{{else}}-{{end}}</div>
                <div class="stat-label">Redundant</div>
            </div>
        </div>
        <div class="scan-config-divider">
            {{template "scan-config-content" .}}
        </div>
    </div>
</div>
<script>
(function() {
    var source = new EventSource('/sse/scan/{{.Run.ID}}');
    var phasesCreated = 0;
    var phaseNames = {}; // Store phase names as they're reported

    function createPhaseElement(num) {
        var phaseEl = document.createElement('div');
        phaseEl.id = 'phase-' + num;
        phaseEl.className = 'phase-item pending';
        phaseEl.innerHTML =
            '<div class="phase-header">' +
                '<span class="phase-number">' + num + '</span>' +
                '<span class="phase-name">Phase ' + num + '</span>' +
                '<span class="phase-status"></span>' +
            '</div>' +
            '<div class="phase-bar-wrapper">' +
                '<div class="phase-bar"></div>' +
            '</div>';
        return phaseEl;
    }

    function ensurePhasesExist(total) {
        if (phasesCreated >= total) return;

        var timeline = document.getElementById('phase-timeline');
        for (var i = phasesCreated + 1; i <= total; i++) {
            var phaseEl = createPhaseElement(i);
            // Apply stored name if we have one
            if (phaseNames[i]) {
                phaseEl.querySelector('.phase-name').textContent = phaseNames[i];
            }
            timeline.appendChild(phaseEl);
        }
        phasesCreated = total;
    }

    source.addEventListener('progress', function(e) {
        try {
            var data = JSON.parse(e.data);

            // Update stats (show '-' for zero values)
            var filesEl = document.getElementById('files-scanned');
            var bytesEl = document.getElementById('bytes-scanned');
            var groupsEl = document.getElementById('groups-found');
            var wastedEl = document.getElementById('wasted-bytes');

            filesEl.textContent = data.files_scanned > 0 ? data.files_scanned.toLocaleString() : '-';
            bytesEl.textContent = data.bytes_scanned && data.bytes_scanned !== '0 B' ? data.bytes_scanned : '-';
            groupsEl.textContent = data.groups_found > 0 ? data.groups_found.toLocaleString() : '-';
            wastedEl.textContent = data.wasted_bytes && data.wasted_bytes !== '0 B' ? data.wasted_bytes : '-';

            // Update phase timeline
            if (data.phase_num > 0 && data.phase_total > 0) {
                var phaseNum = data.phase_num;
                var phaseTotal = data.phase_total;
                var phasePercent = data.phase_percent;

                // Create phase elements if needed
                ensurePhasesExist(phaseTotal);

                // Store phase name for this phase
                if (data.phase_name) {
                    phaseNames[phaseNum] = data.phase_name.trim();
                }

                // Mark previous phases as completed
                for (var i = 1; i < phaseNum; i++) {
                    var prevPhase = document.getElementById('phase-' + i);
                    if (prevPhase && !prevPhase.classList.contains('completed')) {
                        prevPhase.classList.remove('pending', 'active', 'indeterminate');
                        prevPhase.classList.add('completed');
                        var prevBar = prevPhase.querySelector('.phase-bar');
                        if (prevBar) prevBar.style.width = '100%';
                        var prevStatus = prevPhase.querySelector('.phase-status');
                        if (prevStatus) prevStatus.textContent = '';
                    }
                }

                // Update current phase
                var currentPhase = document.getElementById('phase-' + phaseNum);
                if (currentPhase) {
                    currentPhase.classList.remove('pending', 'completed');

                    // Update phase name
                    if (data.phase_name) {
                        var nameEl = currentPhase.querySelector('.phase-name');
                        if (nameEl) nameEl.textContent = data.phase_name.trim();
                    }

                    var bar = currentPhase.querySelector('.phase-bar');
                    var statusEl = currentPhase.querySelector('.phase-status');

                    if (phasePercent < 0) {
                        // Indeterminate progress
                        currentPhase.classList.add('active', 'indeterminate');
                        if (statusEl) statusEl.textContent = '';
                    } else {
                        // Determinate progress
                        currentPhase.classList.add('active');
                        currentPhase.classList.remove('indeterminate');
                        var percent = Math.round(phasePercent);
                        // Guard against NaN
                        if (isNaN(percent)) percent = 0;
                        if (bar) bar.style.width = percent + '%';
                        if (statusEl) statusEl.textContent = percent + '%';
                    }
                }
            }
        } catch(err) {
            console.error('Failed to parse progress:', err);
        }
    });

    source.addEventListener('complete', function(e) {
        source.close();
        window.location.reload();
    });

    source.onerror = function(e) {
        console.log('SSE error, closing connection');
        source.close();
    };
})();
</script>
{{else}}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{if .Job}}<a href="/jobs/{{.Job.ID}}/edit">{{.Job.Name}}</a>{{else}}Quick Scan{{end}}</div>
        <div class="stat-label">Job</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" title="{{.Run.CompletedAt | formatTime}}">{{.Run.CompletedAt | timeAgo}}</div>
        <div class="stat-label">Scanned</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Run.FilesScanned}}</div>
        <div class="stat-label">Files Scanned</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Run.BytesScanned | formatBytes}}</div>
        <div class="stat-label">Data Scanned</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Run.DuplicateGroups}}</div>
        <div class="stat-label">Duplicate Groups</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Run.WastedBytes | formatBytes}}</div>
        <div class="stat-label">Redundant</div>
    </div>
</div>

{{if .Run.Paths}}
<div class="card">
    <div class="card-header">
        <span>Scan Configuration</span>
    </div>
    <div class="card-body">
        {{template "scan-config-content" .}}
    </div>
</div>
{{end}}

{{if .Run.ErrorMessage}}
<div class="alert alert-error">
    <strong>Error:</strong> {{.Run.ErrorMessage}}
</div>
{{end}}

{{if .GroupsTable.Groups}}
<div class="card">
    <div class="card-header">
        <div class="header-left">
            <span>Duplicate File Groups</span>
            <button type="button" class="btn btn-sm" onclick="toggleAllRows()" aria-label="Expand all duplicate groups" id="expand-all-btn">Expand All</button>
        </div>
        <div class="action-buttons">
            <span id="selection-count" class="muted">0 selected</span>
            <span class="separator"></span>
            <span class="btn-group">
                <span class="btn-wrapper" data-disabled-hint="Select one or more groups first">
                    <button type="button" class="btn btn-primary" id="btn-hardlink" disabled
                            hx-post="/scans/runs/{{.Run.ID}}/action?action=hardlink"
                            hx-include="#action-form"
                            hx-target="body"
                            hx-swap="beforeend">
                        <span class="btn-text">Hardlink…</span>
                        <span class="btn-spinner"><span class="spinner"></span></span>
                    </button>
                </span>
                <span class="btn-wrapper" data-disabled-hint="Select one or more groups first">
                    <button type="button" class="btn btn-primary" id="btn-reflink" disabled
                            hx-post="/scans/runs/{{.Run.ID}}/action?action=reflink"
                            hx-include="#action-form"
                            hx-target="body"
                            hx-swap="beforeend">
                        <span class="btn-text">Reflink…</span>
                        <span class="btn-spinner"><span class="spinner"></span></span>
                    </button>
                </span>
                <span class="btn-wrapper" data-disabled-hint="Select one or more groups first">
                    <button type="button" class="btn btn-danger" id="btn-remove" disabled
                            onclick="openRemoveModal()">
                        <span class="btn-text">Remove…</span>
                    </button>
                </span>
                <button type="button" class="help-icon" onclick="toggleLinkHelp(this)">?</button>
            </span>
        </div>
    </div>
    <div class="card-body">
        <!-- Hidden inputs for action buttons -->
        <form id="action-form">
            {{csrfField .CSRFToken}}
            <input type="hidden" name="group_ids" id="selected-groups" value="">
            <input type="hidden" name="select_all" id="select-all-flag" value="">
            <input type="hidden" name="status_filter" id="status-filter" value="{{.GroupsTable.StatusFilter}}">
        </form>

        <!-- File action bar (shown when individual files are selected) -->
        <div id="file-action-bar" class="file-action-bar" style="display:none">
            <span id="file-selection-count" class="muted">0 files selected</span>
            <button type="button" class="btn btn-danger btn-sm" id="btn-delete-files"
                    hx-post="/scans/runs/{{.Run.ID}}/delete-files"
                    hx-include="#file-delete-form"
                    hx-target="body"
                    hx-swap="beforeend">
                <span class="btn-text">Delete…</span>
                <span class="btn-spinner"><span class="spinner"></span></span>
            </button>
            <button type="button" class="btn btn-sm" onclick="clearFileSelection()">Clear</button>
        </div>

        <!-- Hidden form for file deletion -->
        <form id="file-delete-form" style="display:none">
            {{csrfField .CSRFToken}}
            <input type="hidden" name="file_paths" id="selected-file-paths" value="">
            <input type="hidden" name="group_ids" id="selected-file-group-ids" value="">
        </form>

        {{template "groups-table" .GroupsTable}}
    </div>
</div>

<script>
var selectAllMode = false;
var manualSelections = new Set();
var totalCount = {{.GroupsTable.TotalCount}};

function toggleRow(event, id) {
    if (event.target.type === 'checkbox') return;
    var row = document.getElementById('expanded-' + id);
    var isExpanded = row.classList.toggle('show');
    // Update aria-expanded on the parent row
    var parentRow = row.previousElementSibling;
    if (parentRow) {
        parentRow.setAttribute('aria-expanded', isExpanded);
    }
    updateExpandButtonText();
}

function handleRowKeydown(event, id) {
    if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        toggleRow(event, id);
    }
}

var allExpanded = false;

function toggleAllRows() {
    var rows = document.querySelectorAll('.expanded-content');
    allExpanded = !allExpanded;
    rows.forEach(function(row) {
        if (allExpanded) {
            row.classList.add('show');
        } else {
            row.classList.remove('show');
        }
        // Update aria-expanded on the parent row
        var parentRow = row.previousElementSibling;
        if (parentRow) {
            parentRow.setAttribute('aria-expanded', allExpanded);
        }
    });
    updateExpandButtonText();
}

function updateExpandButtonText() {
    var rows = document.querySelectorAll('.expanded-content');
    var expandedCount = document.querySelectorAll('.expanded-content.show').length;
    allExpanded = expandedCount === rows.length && rows.length > 0;
    var btn = document.querySelector('.header-left .btn');
    if (btn) {
        btn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
    }
}

function togglePage(checkbox) {
    selectAllMode = checkbox.checked;
    manualSelections.clear();

    // Update all row checkboxes visually
    document.querySelectorAll('.group-checkbox').forEach(function(cb) {
        cb.checked = selectAllMode;
    });

    updateSelectionDisplay();
}

function updateSelection() {
    // Exit select-all mode when manually changing selections
    if (selectAllMode) {
        selectAllMode = false;
        document.getElementById('select-page').checked = false;
    }

    manualSelections.clear();
    document.querySelectorAll('.group-checkbox:checked').forEach(function(cb) {
        manualSelections.add(cb.value);
    });

    // Update page checkbox
    const allOnPage = document.querySelectorAll('.group-checkbox');
    const checkedOnPage = document.querySelectorAll('.group-checkbox:checked');
    document.getElementById('select-page').checked = allOnPage.length > 0 && allOnPage.length === checkedOnPage.length;

    updateSelectionDisplay();
}

function updateSelectionDisplay() {
    var countEl = document.getElementById('selection-count');
    var groupIdsEl = document.getElementById('selected-groups');
    var selectAllFlagEl = document.getElementById('select-all-flag');
    var btnHardlink = document.getElementById('btn-hardlink');
    var btnReflink = document.getElementById('btn-reflink');
    var btnRemove = document.getElementById('btn-remove');

    var hasSelection = false;

    if (selectAllMode) {
        countEl.textContent = totalCount + ' selected';
        groupIdsEl.value = '';
        selectAllFlagEl.value = '1';
        hasSelection = totalCount > 0;
    } else {
        var count = manualSelections.size;
        countEl.textContent = count + ' selected';
        hasSelection = count > 0;
        groupIdsEl.value = Array.from(manualSelections).join(',');
        selectAllFlagEl.value = '';
    }

    btnHardlink.disabled = !hasSelection;
    btnReflink.disabled = !hasSelection;
    btnRemove.disabled = !hasSelection;
}

function sortBy(field) {
    var currentSort = '{{.GroupsTable.SortBy}}';
    var currentOrder = '{{.GroupsTable.SortOrder}}';

    var newOrder = 'desc';
    if (field === currentSort) {
        // Toggle order if clicking same column
        newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
    }

    window.location.href = '?sort=' + field + '&order=' + newOrder;
}

// Handle clicks on disabled action buttons via wrapper
document.querySelectorAll('.btn-wrapper').forEach(function(wrapper) {
    wrapper.addEventListener('click', function(e) {
        var btn = wrapper.querySelector('button');
        if (btn && btn.disabled) {
            e.preventDefault();
            e.stopPropagation();
            showToast(wrapper.dataset.disabledHint || 'Button is disabled', 'error');
        }
    });
});

// Remove modal functions
function openRemoveModal() {
    document.getElementById('remove-modal-backdrop').style.display = 'flex';
    document.body.classList.add('modal-open');
    updateRemoveHint();
}

function closeRemoveModal() {
    document.getElementById('remove-modal-backdrop').style.display = 'none';
    document.body.classList.remove('modal-open');
}

function updateRemoveHint() {
    var hints = {
        'least-recently-modified': 'Keep: most recently modified file from each group.',
        'most-recently-modified': 'Keep: least recently modified file from each group.',
        'oldest': 'Keep: most recently created file from each group.',
        'newest': 'Keep: least recently created file from each group.',
        'least-nested': 'Keep: most deeply nested file from each group.',
        'most-nested': 'Keep: least nested file from each group.',
        'top': 'Keep: bottom listed file from each group.',
        'bottom': 'Keep: top listed file from each group.'
    };
    var select = document.getElementById('remove-priority');
    var hint = document.getElementById('remove-hint');
    hint.textContent = hints[select.value] || '';
}

// File selection for manual deletion
var selectedFiles = new Set();

function updateFileSelection() {
    selectedFiles.clear();
    var groupIds = new Set();
    document.querySelectorAll('.file-checkbox:checked').forEach(function(cb) {
        selectedFiles.add(cb.dataset.filePath);
        groupIds.add(cb.dataset.groupId);
    });

    var bar = document.getElementById('file-action-bar');
    var countEl = document.getElementById('file-selection-count');
    var pathsEl = document.getElementById('selected-file-paths');
    var groupIdsEl = document.getElementById('selected-file-group-ids');

    if (selectedFiles.size > 0) {
        bar.style.display = 'flex';
        countEl.textContent = selectedFiles.size + ' file' + (selectedFiles.size === 1 ? '' : 's') + ' selected';
        pathsEl.value = Array.from(selectedFiles).join('\n');
        groupIdsEl.value = Array.from(groupIds).join(',');
    } else {
        bar.style.display = 'none';
    }
}

function clearFileSelection() {
    document.querySelectorAll('.file-checkbox:checked').forEach(function(cb) {
        cb.checked = false;
    });
    updateFileSelection();
}

// Initialize on page load (handles browser-restored checkbox state)
// If browser restored the "select page" checkbox, restore selectAllMode
if (document.getElementById('select-page').checked) {
    selectAllMode = true;
    updateSelectionDisplay();
} else {
    updateSelection();
}
updateFileSelection();
</script>

<!-- Remove Options Modal -->
<div id="remove-modal-backdrop" class="modal-backdrop" style="display:none" onclick="closeRemoveModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>Remove Duplicates</h3>
            <button class="modal-close" onclick="closeRemoveModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Choose which files to prioritize for removal. One file per group will be kept.</p>
            <div class="form-field" style="display:flex; align-items:center; gap:0.5rem;">
                <label for="remove-priority">Remove:</label>
                <select id="remove-priority" name="remove-priority" class="form-select" onchange="updateRemoveHint()">
                    <option value="least-recently-modified">Oldest modified</option>
                    <option value="most-recently-modified">Newest modified</option>
                    <option value="oldest">Oldest created</option>
                    <option value="newest">Newest created</option>
                    <option value="least-nested">Least nested</option>
                    <option value="most-nested">Most nested</option>
                    <option value="top">Top listed</option>
                    <option value="bottom">Bottom listed</option>
                </select>
            </div>
            <p id="remove-hint" class="muted" style="margin:0.5rem 0 0; font-size:0.85rem;">Keep: most recently modified file from each group.</p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeRemoveModal()">Cancel</button>
            <button class="btn btn-danger" id="btn-remove-preview"
                    hx-post="/scans/runs/{{.Run.ID}}/action?action=remove"
                    hx-include="#action-form, #remove-priority"
                    hx-target="body"
                    hx-swap="beforeend">
                <span class="btn-text">Preview…</span>
                <span class="btn-spinner"><span class="spinner"></span></span>
            </button>
        </div>
    </div>
</div>
{{else}}
{{if eq .Run.Status "completed"}}
<div class="empty-state">
    <h3>No duplicates found</h3>
    <p>The scan completed without finding any duplicate files.</p>
</div>
{{else if eq .Run.Status "cancelled"}}
<div class="empty-state">
    <h3>Scan cancelled</h3>
    <p>The scan was cancelled before completion.</p>
</div>
{{else if eq .Run.Status "failed"}}
<div class="empty-state">
    <h3>Scan failed</h3>
    <p>The scan encountered an error and did not complete.</p>
</div>
{{end}}
{{end}}

{{if .Actions}}
<div class="card">
    <div class="card-header">Actions</div>
    {{template "actions-table" .Actions}}
</div>
{{end}}
{{end}}
{{end}}
