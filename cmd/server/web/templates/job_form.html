{{define "content"}}
<div class="page-header">
    <h1>{{if .Job}}Edit{{else}}New{{end}} Scheduled Job</h1>
</div>

{{if .Error}}
<div class="alert alert-error">{{.Error}}</div>
{{end}}

<div class="card">
    <div class="card-body">
        <form method="POST" action="{{if .Job}}/jobs/{{.Job.ID}}{{else}}/jobs{{end}}">
            {{csrfField .CSRFToken}}
            <div class="form-group form-group-narrow">
                <label class="form-label" for="name">Name <button type="button" class="help-icon" onclick="toggleNameHelp(this)">?</button></label>
                <input type="text" id="name" name="name" class="form-input"
                       value="{{if .Job}}{{.Job.Name}}{{end}}" required
                       placeholder="Photos" autocomplete="off">
            </div>

            <div class="form-group form-group-narrow">
                <label class="form-label">Paths to Scan <button type="button" class="help-icon" onclick="togglePathsHelp(this, {{if .AllowedPaths}}true{{else}}false{{end}})">?</button></label>
                <div class="list-input" id="paths-container">
                    <div class="list-items" id="paths-list">
                        {{if .Job}}{{range .Job.Paths}}
                        <div class="list-item">
                            <input type="hidden" name="paths" value="{{.}}">
                            <span class="list-item-text">{{.}}</span>
                            <button type="button" class="list-item-remove" aria-label="Remove" onclick="removeListItem(this)">&times;</button>
                        </div>
                        {{end}}{{end}}
                    </div>
                    <div class="list-add">
                        <input type="text" id="new-path" class="form-input"
                               placeholder="/path/to/directory" data-path-autocomplete
                               autocorrect="off" autocapitalize="off" spellcheck="false">
                        <button type="button" class="btn" onclick="addPath()">Add</button>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="min_size">Minimum Size <button type="button" class="help-icon" onclick="toggleSizeHelp(this)">?</button></label>
                    <input type="text" id="min_size" name="min_size" class="form-input"
                           value="{{if .Job}}{{formatSizeInput .Job.MinSize}}{{end}}"
                           placeholder="1 MB" autocorrect="off" autocapitalize="off">
                </div>

                <div class="form-group">
                    <label class="form-label" for="max_size">Maximum Size <button type="button" class="help-icon" onclick="toggleSizeHelp(this)">?</button></label>
                    <input type="text" id="max_size" name="max_size" class="form-input"
                           value="{{if .Job}}{{if .Job.MaxSize}}{{formatSizeInput (derefInt64 .Job.MaxSize)}}{{end}}{{end}}"
                           placeholder="10 GB" autocorrect="off" autocapitalize="off">
                </div>
            </div>

            <div class="form-row-wide">
                <div class="form-group">
                    <label class="form-label">Include Patterns <button type="button" class="help-icon" onclick="toggleGlobHelp(this)">?</button></label>
                    <div class="list-input" id="include-container">
                        <div class="list-items" id="include-list">
                            {{if .Job}}{{range .Job.IncludePatterns}}
                            <div class="list-item">
                                <input type="hidden" name="include_patterns" value="{{.}}">
                                <span class="list-item-text">{{.}}</span>
                                <button type="button" class="list-item-remove" aria-label="Remove" onclick="removeListItem(this)">&times;</button>
                            </div>
                            {{end}}{{end}}
                        </div>
                        <div class="list-add">
                            <input type="text" id="new-include" class="form-input" placeholder="**.jpg or **/include/*.png"
                                   autocorrect="off" autocapitalize="off" spellcheck="false">
                            <button type="button" class="btn" onclick="addPattern('include')">Add</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Exclude Patterns <button type="button" class="help-icon" onclick="toggleGlobHelp(this)">?</button></label>
                    <div class="list-input" id="exclude-container">
                        <div class="list-items" id="exclude-list">
                            {{if .Job}}{{range .Job.ExcludePatterns}}
                            <div class="list-item">
                                <input type="hidden" name="exclude_patterns" value="{{.}}">
                                <span class="list-item-text">{{.}}</span>
                                <button type="button" class="list-item-remove" aria-label="Remove" onclick="removeListItem(this)">&times;</button>
                            </div>
                            {{end}}{{end}}
                        </div>
                        <div class="list-add">
                            <input type="text" id="new-exclude" class="form-input" placeholder="**.xmp or /dev/**"
                                   autocorrect="off" autocapitalize="off" spellcheck="false">
                            <button type="button" class="btn" onclick="addPattern('exclude')">Add</button>
                        </div>
                    </div>
                </div>
            </div>

            <details class="advanced-section">
                <summary class="advanced-toggle">Advanced Options</summary>
                <div class="advanced-content">
                    <div class="form-row">
                        <div class="form-group">
                            <div class="advanced-option">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="include_hidden" value="1"
                                           {{if .Job}}{{if .Job.IncludeHidden}}checked{{end}}{{end}}>
                                    <span>Include hidden files</span>
                                </label>
                                <button type="button" class="help-icon" onclick="toggleAdvancedHelp(this, 'hidden')">?</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="advanced-option">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="follow_links" value="1"
                                           {{if .Job}}{{if .Job.FollowLinks}}checked{{end}}{{end}}>
                                    <span>Follow symbolic links</span>
                                </label>
                                <button type="button" class="help-icon" onclick="toggleAdvancedHelp(this, 'symlinks')">?</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <div class="advanced-option">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="one_file_system" value="1"
                                           {{if .Job}}{{if .Job.OneFileSystem}}checked{{end}}{{end}}>
                                    <span>Same filesystem only</span>
                                </label>
                                <button type="button" class="help-icon" onclick="toggleAdvancedHelp(this, 'filesystem')">?</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="advanced-option">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="no_ignore" value="1"
                                           {{if .Job}}{{if .Job.NoIgnore}}checked{{end}}{{end}}>
                                    <span>Ignore .gitignore</span>
                                </label>
                                <button type="button" class="help-icon" onclick="toggleAdvancedHelp(this, 'gitignore')">?</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <div class="advanced-option">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="ignore_case" value="1"
                                           {{if .Job}}{{if .Job.IgnoreCase}}checked{{end}}{{end}}>
                                    <span>Case-insensitive patterns</span>
                                </label>
                                <button type="button" class="help-icon" onclick="toggleAdvancedHelp(this, 'case')">?</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="advanced-option">
                                <span class="checkbox-spacer"></span>
                                <span class="advanced-option-label">Max Depth</span>
                                <input type="number" id="max_depth" name="max_depth" class="form-input-compact"
                                       value="{{if .Job}}{{if .Job.MaxDepth}}{{derefInt .Job.MaxDepth}}{{end}}{{end}}"
                                       placeholder="None" min="0">
                                <button type="button" class="help-icon" onclick="toggleAdvancedHelp(this, 'depth')">?</button>
                            </div>
                        </div>
                    </div>
                </div>
            </details>

            <hr class="form-divider">

            <div class="form-row-wide">
                <div class="form-group">
                    <label class="form-label" for="cron_expression">Schedule <button type="button" class="help-icon" onclick="toggleCronHelp(this)">?</button></label>
                    <input type="text" id="cron_expression" name="cron_expression" class="form-input"
                           value="{{if .Job}}{{.Job.CronExpression}}{{else}}30 2 * * *{{end}}" required
                           placeholder="30 2 * * *" autocorrect="off" autocapitalize="off" spellcheck="false">
                    <p class="cron-description" id="cron-description"></p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="action">Action After Scan <button type="button" class="help-icon" onclick="toggleActionHelp(this)">?</button></label>
                    <select id="action" name="action" class="form-select" required>
                        <option value="scan" {{if .Job}}{{if eq .Job.Action "scan"}}selected{{end}}{{end}}>
                            Scan Only
                        </option>
                        <option value="scan_hardlink" {{if .Job}}{{if eq .Job.Action "scan_hardlink"}}selected{{end}}{{end}}>
                            Scan + Hardlink
                        </option>
                        <option value="scan_reflink" {{if .Job}}{{if eq .Job.Action "scan_reflink"}}selected{{end}}{{end}}>
                            Scan + Reflink
                        </option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="enabled" value="1"
                           {{if .Job}}{{if .Job.Enabled}}checked{{end}}{{else}}checked{{end}}>
                    Enable this job
                </label>
            </div>

            <input type="hidden" name="run_after_save" id="run_after_save" value="">
            <div class="actions-bar">
                <button type="submit" class="btn btn-primary" id="btn-save">
                    {{if .Job}}Save{{else}}Create{{end}}
                </button>
                <button type="submit" class="btn btn-primary" id="btn-save-run" onclick="document.getElementById('run_after_save').value='1'">
                    {{if .Job}}Run{{else}}Create and Run{{end}}
                </button>
                <a href="/jobs" class="btn">Cancel</a>
                {{if .Job}}
                <button type="button" class="btn btn-danger"
                        onclick="confirmDelete('/jobs/{{.Job.ID}}', 'Job')">
                    Delete
                </button>
                {{end}}
            </div>
        </form>
    </div>
</div>

<script>
// Cron expression parser
(function() {
    var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    var months = ['January', 'February', 'March', 'April', 'May', 'June',
                  'July', 'August', 'September', 'October', 'November', 'December'];

    function formatTime(hour, minute) {
        var h = parseInt(hour, 10);
        var m = parseInt(minute, 10);
        return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
    }

    function ordinal(n) {
        var s = ['th', 'st', 'nd', 'rd'];
        var v = n % 100;
        return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function parseCron(expr) {
        var parts = expr.trim().split(/\s+/);
        if (parts.length !== 5) return null;

        var minute = parts[0], hour = parts[1], dom = parts[2], month = parts[3], dow = parts[4];
        var minStep = minute.match(/^\*\/(\d+)$/);
        var hourStep = hour.match(/^\*\/(\d+)$/);

        if (minute === '*' && hour === '*' && dom === '*' && month === '*' && dow === '*') {
            return 'Every minute';
        }
        if (minStep && hour === '*' && dom === '*' && month === '*' && dow === '*') {
            var n = parseInt(minStep[1], 10);
            return 'Every ' + n + ' minute' + (n > 1 ? 's' : '');
        }
        if (minute.match(/^\d+$/) && hour === '*' && dom === '*' && month === '*' && dow === '*') {
            var m = parseInt(minute, 10);
            if (m === 0) return 'Every hour';
            return 'Every hour at ' + m + ' minute' + (m > 1 ? 's' : '') + ' past';
        }
        if (minute.match(/^\d+$/) && hourStep && dom === '*' && month === '*' && dow === '*') {
            var n = parseInt(hourStep[1], 10);
            var m = parseInt(minute, 10);
            if (m === 0) return 'Every ' + n + ' hour' + (n > 1 ? 's' : '');
            return 'Every ' + n + ' hour' + (n > 1 ? 's' : '') + ' at ' + m + ' minutes past';
        }
        if (!minute.match(/^\d+$/) || !hour.match(/^\d+$/)) return null;

        var time = formatTime(hour, minute);
        if (dom === '*' && month === '*' && dow === '*') {
            return 'Daily at ' + time;
        }
        if (dom === '*' && month === '*' && dow.match(/^\d$/)) {
            var d = parseInt(dow, 10);
            if (d >= 0 && d <= 6) return 'Weekly on ' + days[d] + ' at ' + time;
        }
        if (dom.match(/^\d+$/) && month === '*' && dow === '*') {
            return 'Monthly on the ' + ordinal(parseInt(dom, 10)) + ' at ' + time;
        }
        if (dom.match(/^\d+$/) && month.match(/^\d+$/) && dow === '*') {
            var mo = parseInt(month, 10);
            if (mo >= 1 && mo <= 12) return 'Yearly on ' + months[mo - 1] + ' ' + ordinal(parseInt(dom, 10)) + ' at ' + time;
        }
        return null;
    }

    function updateDescription() {
        var input = document.getElementById('cron_expression');
        var desc = document.getElementById('cron-description');
        var result = parseCron(input.value);
        if (result) {
            desc.textContent = result;
            desc.className = 'cron-description cron-valid';
        } else if (input.value.trim().split(/\s+/).length === 5) {
            desc.textContent = 'Custom schedule';
            desc.className = 'cron-description cron-valid';
        } else {
            desc.textContent = 'Invalid cron expression';
            desc.className = 'cron-description cron-invalid';
        }
    }

    document.getElementById('cron_expression').addEventListener('input', updateDescription);
    updateDescription();
})();

{{if .Job}}
// Form change detection for existing jobs
(function() {
    var form = document.querySelector('form');
    var btnSave = document.getElementById('btn-save');
    var btnSaveRun = document.getElementById('btn-save-run');
    var initialState = serializeForm(form);
    var pendingInputIds = ['new-path', 'new-include', 'new-exclude'];

    function serializeForm(f) {
        var data = new FormData(f);
        var result = [];
        data.forEach(function(value, key) {
            if (key !== 'run_after_save') {
                result.push(key + '=' + value);
            }
        });
        return result.sort().join('&');
    }

    function hasPendingText() {
        return pendingInputIds.some(function(id) {
            var el = document.getElementById(id);
            return el && el.value.trim() !== '';
        });
    }

    function checkChanges() {
        var currentState = serializeForm(form);
        var hasChanges = currentState !== initialState || hasPendingText();

        if (hasChanges) {
            btnSave.disabled = false;
            btnSaveRun.textContent = 'Save and Run';
        } else {
            btnSave.disabled = true;
            btnSaveRun.textContent = 'Run';
        }
    }

    form.addEventListener('input', checkChanges);
    form.addEventListener('change', checkChanges);

    // Initial check
    checkChanges();
})();
{{end}}
</script>
{{end}}
