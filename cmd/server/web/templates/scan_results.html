{{define "content"}}
<div class="page-header">
    <h1>Scan Results</h1>
    <div class="actions-bar">
        {{if eq .Run.Status "running"}}
        <form action="/scans/runs/{{.Run.ID}}/cancel" method="POST">
            <button type="submit" class="btn btn-danger">Cancel Scan</button>
        </form>
        {{end}}
        <a href="/scans" class="btn">Back to Scan Configs</a>
    </div>
</div>

{{if eq .Run.Status "running"}}
<div class="card" id="scan-progress">
    <div class="card-header">
        <span>Scan in Progress</span>
        <span class="loading"></span>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="files-scanned">{{.Run.FilesScanned}}</div>
                <div class="stat-label">Files Scanned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bytes-scanned">{{.Run.BytesScanned | formatBytes}}</div>
                <div class="stat-label">Data Scanned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="groups-found">{{.Run.DuplicateGroups}}</div>
                <div class="stat-label">Groups Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="wasted-bytes">{{.Run.WastedBytes | formatBytes}}</div>
                <div class="stat-label">Wasted Space</div>
            </div>
        </div>
    </div>
</div>
<script>
(function() {
    var source = new EventSource('/sse/scan/{{.Run.ID}}');

    source.addEventListener('progress', function(e) {
        try {
            var data = JSON.parse(e.data);
            document.getElementById('files-scanned').textContent = data.files_scanned;
            document.getElementById('bytes-scanned').textContent = data.bytes_scanned;
            document.getElementById('groups-found').textContent = data.groups_found;
            document.getElementById('wasted-bytes').textContent = data.wasted_bytes;
        } catch(err) {
            console.error('Failed to parse progress:', err);
        }
    });

    source.addEventListener('complete', function(e) {
        source.close();
        window.location.reload();
    });

    source.onerror = function(e) {
        console.log('SSE error, closing connection');
        source.close();
    };
})();
</script>
{{else}}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{.Run.FilesScanned}}</div>
        <div class="stat-label">Files Scanned</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Run.BytesScanned | formatBytes}}</div>
        <div class="stat-label">Data Scanned</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Run.DuplicateGroups}}</div>
        <div class="stat-label">Duplicate Groups</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Run.WastedBytes | formatBytes}}</div>
        <div class="stat-label">Wasted Space</div>
    </div>
</div>

{{if .Run.ErrorMessage}}
<div class="alert alert-error">
    <strong>Error:</strong> {{.Run.ErrorMessage}}
</div>
{{end}}

{{if .Groups}}
<div class="card">
    <div class="card-header">
        <span>Duplicate Groups ({{.TotalCount}} total{{if gt .TotalPages 1}}, page {{.Page}} of {{.TotalPages}}{{end}})</span>
    </div>
    <div class="card-body">
        <!-- Action Form -->
        <div class="action-controls">
            <form id="action-form" method="POST" action="/scans/runs/{{.Run.ID}}/action"
                  hx-post="/scans/runs/{{.Run.ID}}/action"
                  hx-target="body"
                  hx-swap="beforeend">
                <input type="hidden" name="group_ids" id="selected-groups" value="">
                <input type="hidden" name="select_all" id="select-all-flag" value="">
                <input type="hidden" name="status_filter" id="status-filter" value="{{.Status}}">
                <div class="selection-info">
                    <label class="form-checkbox">
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                        <span id="select-all-label">Select all {{.TotalCount}}</span>
                    </label>
                    <button type="button" class="btn btn-sm" onclick="toggleAllRows()">Expand All</button>
                </div>
                <div class="action-buttons">
                    <span id="selection-count" class="muted">0 selected</span>
                    <span class="separator"></span>
                    <label class="form-checkbox" style="margin-right: 1rem;">
                        <input type="checkbox" name="dry_run" value="1" checked id="dry-run-checkbox">
                        Dry run
                    </label>
                    <button type="submit" name="action" value="hardlink" class="btn btn-sm" id="btn-hardlink" disabled>
                        Hardlink Selected
                    </button>
                    <button type="submit" name="action" value="reflink" class="btn btn-sm" id="btn-reflink" disabled>
                        Reflink Selected
                    </button>
                </div>
            </form>
        </div>

        <!-- Groups Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="col-checkbox">
                            <input type="checkbox" id="select-page" onclick="togglePage(this)" title="Select all on this page">
                        </th>
                        <th>Hash Prefix</th>
                        <th class="sortable{{if eq .SortBy "size"}} sorted{{end}}" onclick="sortBy('size')">
                            Size {{if eq .SortBy "size"}}{{if eq .SortOrder "asc"}}▲{{else}}▼{{end}}{{end}}
                        </th>
                        <th class="sortable{{if eq .SortBy "count"}} sorted{{end}}" onclick="sortBy('count')">
                            Count {{if eq .SortBy "count"}}{{if eq .SortOrder "asc"}}▲{{else}}▼{{end}}{{end}}
                        </th>
                        <th class="sortable{{if eq .SortBy "wasted"}} sorted{{end}}" onclick="sortBy('wasted')">
                            Wasted {{if eq .SortBy "wasted"}}{{if eq .SortOrder "asc"}}▲{{else}}▼{{end}}{{end}}
                        </th>
                        <th class="sortable{{if eq .SortBy "status"}} sorted{{end}}" onclick="sortBy('status')">
                            Status {{if eq .SortBy "status"}}{{if eq .SortOrder "asc"}}▲{{else}}▼{{end}}{{end}}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Groups}}
                    <tr class="expandable-row" onclick="toggleRow(event, {{.ID}})">
                        <td class="col-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" class="group-checkbox" value="{{.ID}}"
                                   onchange="updateSelection()">
                        </td>
                        <td class="hash" title="{{.FileHash}}">{{.FileHash | truncateHash}}</td>
                        <td class="size">{{.FileSize | formatBytes}}</td>
                        <td>{{.FileCount}}</td>
                        <td class="size">{{.WastedBytes | formatBytes}}</td>
                        <td><span class="badge badge-{{.Status}}">{{.Status}}</span></td>
                    </tr>
                    <tr id="expanded-{{.ID}}" class="expanded-content">
                        <td colspan="6">
                            <strong>Files:</strong>
                            <ul class="file-list">
                                {{range .Files}}
                                <li>{{.}}</li>
                                {{end}}
                            </ul>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {{if gt .TotalPages 1}}
        <div class="pagination">
            {{if gt .Page 1}}
            <a href="?page={{subtract .Page 1}}&sort={{.SortBy}}&order={{.SortOrder}}" class="btn btn-sm">Previous</a>
            {{else}}
            <span class="btn btn-sm" style="opacity: 0.5;">Previous</span>
            {{end}}

            <span class="pagination-info">
                Page {{.Page}} of {{.TotalPages}}
            </span>

            {{if lt .Page .TotalPages}}
            <a href="?page={{add .Page 1}}&sort={{.SortBy}}&order={{.SortOrder}}" class="btn btn-sm">Next</a>
            {{else}}
            <span class="btn btn-sm" style="opacity: 0.5;">Next</span>
            {{end}}
        </div>
        {{end}}
    </div>
</div>

<script>
var selectAllMode = false;
var manualSelections = new Set();
var totalCount = {{.TotalCount}};

function toggleRow(event, id) {
    if (event.target.type === 'checkbox') return;
    var row = document.getElementById('expanded-' + id);
    row.classList.toggle('show');
    updateExpandButtonText();
}

var allExpanded = false;

function toggleAllRows() {
    var rows = document.querySelectorAll('.expanded-content');
    allExpanded = !allExpanded;
    rows.forEach(function(row) {
        if (allExpanded) {
            row.classList.add('show');
        } else {
            row.classList.remove('show');
        }
    });
    updateExpandButtonText();
}

function updateExpandButtonText() {
    var rows = document.querySelectorAll('.expanded-content');
    var expandedCount = document.querySelectorAll('.expanded-content.show').length;
    allExpanded = expandedCount === rows.length && rows.length > 0;
    var btn = document.querySelector('.selection-info .btn');
    if (btn) {
        btn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
    }
}

function toggleSelectAll(checkbox) {
    selectAllMode = checkbox.checked;
    manualSelections.clear();

    // Update page checkboxes visually
    document.querySelectorAll('.group-checkbox').forEach(cb => {
        cb.checked = selectAllMode;
    });
    document.getElementById('select-page').checked = selectAllMode;

    updateSelectionDisplay();
}

function togglePage(checkbox) {
    if (selectAllMode) {
        // If in select-all mode, clicking page checkbox exits it
        selectAllMode = false;
        document.getElementById('select-all').checked = false;
    }

    document.querySelectorAll('.group-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            manualSelections.add(cb.value);
        } else {
            manualSelections.delete(cb.value);
        }
    });

    updateSelectionDisplay();
}

function updateSelection() {
    if (selectAllMode) {
        // Exit select-all mode when manually changing selections
        selectAllMode = false;
        document.getElementById('select-all').checked = false;
    }

    manualSelections.clear();
    document.querySelectorAll('.group-checkbox:checked').forEach(cb => {
        manualSelections.add(cb.value);
    });

    // Update page checkbox
    const allOnPage = document.querySelectorAll('.group-checkbox');
    const checkedOnPage = document.querySelectorAll('.group-checkbox:checked');
    document.getElementById('select-page').checked = allOnPage.length > 0 && allOnPage.length === checkedOnPage.length;

    updateSelectionDisplay();
}

function updateSelectionDisplay() {
    var countEl = document.getElementById('selection-count');
    var groupIdsEl = document.getElementById('selected-groups');
    var selectAllFlagEl = document.getElementById('select-all-flag');
    var btnHardlink = document.getElementById('btn-hardlink');
    var btnReflink = document.getElementById('btn-reflink');

    var hasSelection = false;

    if (selectAllMode) {
        countEl.textContent = totalCount + ' selected';
        groupIdsEl.value = '';
        selectAllFlagEl.value = '1';
        hasSelection = totalCount > 0;
    } else {
        var count = manualSelections.size;
        countEl.textContent = count + ' selected';
        hasSelection = count > 0;
        groupIdsEl.value = Array.from(manualSelections).join(',');
        selectAllFlagEl.value = '';
    }

    btnHardlink.disabled = !hasSelection;
    btnReflink.disabled = !hasSelection;
}

function sortBy(field) {
    var currentSort = '{{.SortBy}}';
    var currentOrder = '{{.SortOrder}}';

    var newOrder = 'desc';
    if (field === currentSort) {
        // Toggle order if clicking same column
        newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
    }

    window.location.href = '?sort=' + field + '&order=' + newOrder;
}

// Initialize on page load
updateSelectionDisplay();
</script>
{{else}}
<div class="empty-state">
    <h3>No duplicates found</h3>
    <p>The scan completed without finding any duplicate files.</p>
</div>
{{end}}
{{end}}
{{end}}
